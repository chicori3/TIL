# 05. 실행 컨텍스트와 클로저

이번 장에서는 자바스크립트가 실행될 때 생성되는 하나의 실행 단위인 실행 컨텍스트, 변수의 유효 범위, 클로저를 설명한다. 이는 자바스크립트에서 매우 중요한 개념으로서, 이들을 정확히 이해하지 못하면 코드를 이해하기 어렵고, 활용하기 불편할뿐만 아니라 디버깅도 어려울 것이다.

## 1. 실행 컨텍스트 개념

- 실행 컨텍스트는 **"실행 가능한 코드를 형상화하고 구분하는 추상적인 개념"** 으로 기술된다.
- 콜 스택과 연관하여 정의하면 **"실행 가능한 자바스크립트 코드 블록이 실행되는 환경"** 이라고 할 수 있고, 이 컨텍스트 안에 실행에 필요한 여러 가지 정보를 담고 있다.
- **"현재 실행되는 컨텍스트에서 이 컨텍스트와 관련 없는 실행코드가 실행되면, 새로운 컨텍스트가 생성되어 스택에 들어가고 제어권이 그 컨텍스트로 이동한다."**

```javascript
console.log("Global Context"); // Global Context

function ExContext1() {
  console.log("ExContext1");
}

function ExContext2() {
  ExContext1();
  console.log("ExContext2"); // ExContext1
}

ExContext2(); // ExContext2
```

## 2. 실행 컨텍스트 생성 과정

### 2-1. 활성 객체 생성

- 활성 객체는 자바스크립트 엔진이 해당 실행 컨텍스트에서 실행에 필요한 여러 정보를 담은 객체이다.
- 매개변수나 사용자가 정의한 변수 및 개체를 저장하고, 새로 만들어진 컨텍스트로 접근 가능하게 되어 있다.
- 엔진 내부에서 접근할 수 있는 것이지 사용자가 접근할 수는 없다.

### 2-2. arguments 객체 생성

- 앞서 만들어진 활성 객체는 arugments 프로퍼티로 이 arguments 객체를 참조한다.

### 2-3. 스코프 정보 생성

- 현재 컨텍스트의 유효 범위를 나타내는 스코프 정보를 생성한다.
- 이 스코프 정보는 현재 실행 중인 실행 컨텍스트 안에서 연결 리스트와 유사한 형식으로 만들어진다.
- 이 리스트로 현재 컨텍스트의 변수뿐 아니라, 상위 실행 컨텍스트의 변수도 접근이 가능하다.
- 리스트에서 찾지 못한 변수는 결국 정의되지 않은 변수에 접근하는 것으로 판단하여 에러를 검출한다.
- 이 리스트를 스코프 체인이라고 하는데, [[scope]] 프로퍼티로 참조된다.

### 2-4. 변수 생성

- 현재 실행 컨텍스트 내부에서 사용되는 지역 변수의 생성이 이루어진다.
- 실제적으로 앞서 생성된 활성 객체가 변수 객체로 사용된다.(활성 객체 === 변수 객체)
- 변수 객체 안에서 호출된 함수 인자는 각각의 프로퍼티가 만들어지고 그 값이 할당된다.
- 과정에서 변수나 내부 함수를 단지 메모리에 생성하고, 초기화는 각 변수나 함수에 해당하는 표현식이 실행되기 전까지 이루어지지 않는다.

### 2-5. this 바인딩

- 마지막 단계에서 this 키워드를 사용하는 값이 할당된다.
- this가 참조하는 객체가 없으면 전역 객체를 참조한다.

### 2-6. 코드 실행

이렇게 하나의 실행 컨텍스트가 생성되고, 변수 객체가 만들어진 후에, 코드에 있는 여러 표현식 실행이 이루어진다. 이렇게 실행되면서 변수의 초기화 및 연산, 또 다른 함수 실행 등이 이루어진다. 전역 실행 컨텍스트는 일반적인 실행 컨텍스트와는 약간 다른데, arugments 객체가 없으며, 전역 객체 하나만을 포함하는 스코프 체인이 있다. 실행 컨텍스트가 형성되는 세 가지 중 하나로서 전역 코드가 있는데, 이 전역 코드가 실행될 때 생성되는 컨텍스트가 전역 실행 컨텍스트다. 전역 실행 컨텍스트는 변수를 초기화하고 이것의 내부 함수는 일반적인 탑 레벨의 함수로 선언된다. 전역 실행 컨텍스트에서는 변수 객체가 곧 전역 객체이다. 전역적으로 선언된 함수와 변수가 전역 객체의 프로퍼티가 된다.

> Node.js에서는 최상위 코드가 브라우저와는 달리 전역 코드가 아니다.

## 3. 스코프 체인

자바스크립트 코드를 이해하려면 스코프 체인의 이해는 필수적이다. 변수에 대한 인식 메커니즘을 알 수 있고, 현재 사용되는 변수가 어디에서 선언된 변수인지 정확히 알 수 있기 때문이다. 자바스크립트도 다른 언어와 마찬가지로 스코프, 즉 유효 범위가 있다. 자바스크립트에서는 오직 함수만이 유효 범위의 한 단위가 된다. 이 유효 범위를 나타내는 스코프가 [[scope]] 프로퍼티로 각 함수 객체 내에서 연결 리스트 형식으로 관리되는데, 이를 **스코프 체인**이라고 한다. **각각의 함수는 [[scope]] 프로퍼티로 자신이 생성된 실행 컨텍스트의 스코프 체인을 참조한다.** 함수가 실행되는 순간 실행 컨텍스트가 만들어지고, **이 실행 컨텍스트는 실행된 함수의 [[scope]] 프로퍼티를 기반으로 새로운 스코프 체인을 만든다.**

### 3-1. 전역 실행 컨텍스트의 스코프 체인

```javascript
var var1 = 1;

console.log(var1); // 1
```

- 예제는 전역 코드이다. 함수가 선언되지 않아 함수 호출이 없고, 실행 가능한 코드만 나열한다.
- 위 코드를 실행하면, 전역 실행 컨텍스트가 생성되고, 변수 객체가 만들어진다.
- 전역 실행 컨텍스트가 단 하나만 실행되고 있어 위 변수 객체의 스코프 체인은 자기 자신만을 가진다.
- 변수 객체의 [[scope]]는 변수 객체 자신을 가리키고, var1 변수가 생성되고 변수 객체에 의해 참조된다.

### 3-2. 함수를 호출한 경우 생성되는 실행 컨텍스트의 스코프 체인

```javascript
var var1 = 1;
function func() {
  var var1 = 10;
  console.log(var1); // 10
}
func();
console.log(var1); // 1
```

- **각 함수 객체는 [[scope]] 프로퍼티로 현재 컨텍스트의 스코프 체인을 참조한다.**
- 한 함수가 실행되면 새로운 실행 컨텍스트가 만들어지고, 이 실행 컨텍스트는 자신이 사용할 스코프 체인을 **현재 실행되는 함수 객체의 [[scope]] 프로퍼티를 복사하고, 새롭게 생성된 변수 객체를 해당 체인의 제일 앞에 추가한다.**
- **스코프 체인 = 현재 실행 컨텍스트의 변수 객체 + 상위 컨텍스트의 스코프 체인**

```javascript
var value = "value1";

function printFunc() {
  var value = "value2";

  function printValue() {
    return value;
  }

  console.log(printValue()); // value2
}

printFunc();
```

```javascript
var value = "value1";

function printValue() {
  return value;
}

function printFunc(func) {
  var value = "value2";
  console.log(func());
}

printFunc(printValue);
```

#### 정리

1. 만들어진 스코프 체인으로 식별자 인식이 이루어진다.
2. 식별자 인식은 스코프 체인의 첫 번째 변수 객체부터 시작한다.
3. 식별자와 대응되는 이름을 가진 프로퍼티가 있는지를 확인한다.
4. 함수를 호출할 때 스코프 체인의 가장 앞에 있는 객체가 변수 객체이므로, 이 객체에 있는 공식 인자. 내부 함수, 지역 변수에 대응되는지 먼저 확인한다.
5. 첫 번째 객체에 대응되는 프로퍼티를 발견하지 못하면, 다음 객체로 이동하여 찾을 때까지 계속된다.
6. 여기서 this는 식별자가 아닌 키워드로 분류되므로, 스코프 체인의 참조 없이 접근할 수 있다.
